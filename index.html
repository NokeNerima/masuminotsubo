<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>„Åæ„Åô„Åø„ÅÆ„Å§„Åº„Äê„Åä„Åò„ÅÑ„Å°„ÇÉ„ÇìÂÇòÂØøË®òÂøµ„Ç≤„Éº„É†„Äë</title>
<style>
body { margin:0; font-family:sans-serif; text-align:center; background:#f0f8ff; touch-action:none; display:flex; justify-content:center; align-items:flex-start; padding-top:50px;}
#original { width:300px; height:300px; border:2px solid #444; margin-right:50px; background-size:cover; background-position:center;}
#puzzle { display:inline-block; position:relative; width:300px; height:300px; }
.piece {
  width:100px; height:100px; position:absolute; border:1px solid #ccc;
  background-size:300px 300px; cursor:pointer;
  transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1), top 0.3s cubic-bezier(0.4,0,0.2,1);
}
#message { margin-top:20px; font-size:24px; color:#d2691e; font-weight:bold; width:100%; }
#nextBtn { display:none; margin-top:20px; padding:10px 20px; font-size:18px; cursor:pointer; }
</style>
</head>
<body>

<div id="original"></div>
<div>
  <div id="puzzle"></div>
  <div id="message"></div>
  <button id="nextBtn">Ê¨°„Å∏ ‚ñ∂</button>
</div>

<script>
const rows = 3, cols = 3;
const size = 100;
const puzzle = document.getElementById('puzzle');
const original = document.getElementById('original');
const nextBtn = document.getElementById('nextBtn');
let pieces = [];
let empty = {x:cols-1, y:rows-1};
let startX=0, startY=0;

// Â£∫ÁîªÂÉè„É™„Çπ„Éà
const images = [ '1.png','3.png','4.png','5.png',
  '6.png','7.png','8.png','9.png','10.png',
  '11.png','12.png','14.png','15.png',
  '16.png','17.png','18.png','19.png','20.png',
  '21.png','22.png','23.png','24.png','25.png'];
let imageUrl = '';

// SE„Éï„Ç°„Ç§„É´Ôºà„É≠„Éº„Ç´„É´„Åß„ÇÇÂèØÔºâ
const seSwipeUrl = '„Ç≥„É´„ÇØÊ†ì„ÇíÊäú„Åè1.mp3'; // Êìç‰ΩúÁî®
const seClearUrl = 'levelup.mp3'; // „ÇØ„É™„Ç¢Áî®
function initPuzzle(){
  imageUrl = images[Math.floor(Math.random()*images.length)];
  original.style.backgroundImage = `url(${imageUrl})`;

  pieces.forEach(p=>p.remove());
  pieces=[];
  empty = {x:cols-1, y:rows-1};
  nextBtn.style.display='none';
  document.getElementById('message').textContent='';

  for(let y=0;y<rows;y++){
    for(let x=0;x<cols;x++){
      if(x===empty.x && y===empty.y) continue;
      const piece = document.createElement('div');
      piece.className='piece';
      piece.style.left = x*size+'px';
      piece.style.top = y*size+'px';
      piece.style.backgroundImage = `url(${imageUrl})`;
      piece.style.backgroundPosition = `-${x*size}px -${y*size}px`;
      piece.dataset.x=x;
      piece.dataset.y=y;
      puzzle.appendChild(piece);
      pieces.push(piece);

      // „ÇØ„É™„ÉÉ„ÇØ„ÅßÁßªÂãï
      piece.addEventListener('click', e=>{
        const rect = piece.getBoundingClientRect();
        movePiece(piece,true,true,rect.left+size/2, rect.top+size/2);
      });

      // „Çø„ÉÉ„ÉÅÊìç‰Ωú
      piece.addEventListener('touchstart', e=>{
        const t=e.touches[0];
        startX=t.clientX;
        startY=t.clientY;
      });
      piece.addEventListener('touchend', e=>{
        const t=e.changedTouches[0];
        const dx = t.clientX-startX;
        const dy = t.clientY-startY;
        const rect = piece.getBoundingClientRect();
        const cx = rect.left+size/2;
        const cy = rect.top+size/2;

        if(Math.abs(dx)>Math.abs(dy)){
          if(dx>20) swipeMove(piece,'right',cx,cy);
          else if(dx<-20) swipeMove(piece,'left',cx,cy);
        }else{
          if(dy>20) swipeMove(piece,'down',cx,cy);
          else if(dy<-20) swipeMove(piece,'up',cx,cy);
        }
      });
    }
  }

  // „Ç∑„É£„ÉÉ„Éï„É´
  for(let i=0;i<150;i++){
    const movable = getMovablePieces();
    const p = movable[Math.floor(Math.random()*movable.length)];
    movePiece(p,false,false);
  }
}

// „Çπ„ÉØ„Ç§„ÉóÁßªÂãï
function swipeMove(piece,direction,cx,cy){
  const x=parseInt(piece.dataset.x);
  const y=parseInt(piece.dataset.y);
  if(direction==='left' && x+1===empty.x && y===empty.y) movePiece(piece,true,true,cx,cy);
  if(direction==='right' && x-1===empty.x && y===empty.y) movePiece(piece,true,true,cx,cy);
  if(direction==='up' && y+1===empty.y && x===empty.x) movePiece(piece,true,true,cx,cy);
  if(direction==='down' && y-1===empty.y && x===empty.x) movePiece(piece,true,true,cx,cy);
}

// Âãï„Åã„Åõ„Çã„Éî„Éº„ÇπÂèñÂæó
function getMovablePieces(){
  return pieces.filter(p=>{
    const x=parseInt(p.dataset.x);
    const y=parseInt(p.dataset.y);
    return (x===empty.x && Math.abs(y-empty.y)===1) ||
           (y===empty.y && Math.abs(x-empty.x)===1);
  });
}

// „Éî„Éº„ÇπÁßªÂãï
function movePiece(piece,check=true,withEffect=false,x=0,y=0){
  const px=parseInt(piece.dataset.x);
  const py=parseInt(piece.dataset.y);
  if(!((px===empty.x && Math.abs(py-empty.y)===1) || (py===empty.y && Math.abs(px-empty.x)===1))) return;

  const tempX = piece.dataset.x;
  const tempY = piece.dataset.y;
  piece.dataset.x = empty.x;
  piece.dataset.y = empty.y;
  piece.style.left = empty.x*size+'px';
  piece.style.top = empty.y*size+'px';
  empty.x = parseInt(tempX);
  empty.y = parseInt(tempY);

  if(withEffect) triggerEffect(x,y);

  if(check && isCompleted()) showMessage();
}

// ÂÆåÊàêÂà§ÂÆö
function isCompleted(){
  return pieces.every(p=>{
    const x=parseInt(p.dataset.x);
    const y=parseInt(p.dataset.y);
    const origX = parseInt(p.style.backgroundPositionX)/-size;
    const origY = parseInt(p.style.backgroundPositionY)/-size;
    return x===origX && y===origY;
  });
}

// „Ç®„Éï„Çß„ÇØ„ÉàÔºãSE
function triggerEffect(cx,cy){
  // SE
  const audio = new Audio(seSwipeUrl);
  audio.volume=0.3;
  audio.play();

  // Á¥ôÂêπÈõ™„Äå„Ç∑„É•„ÉÉ„Äç„Å®ÊµÅ„Çå„Çã
  for(let i=0;i<5;i++){
    const confetti = document.createElement('div');
    confetti.textContent='‚ú®';
    confetti.style.position='absolute';
    confetti.style.fontSize=Math.random()*20+10+'px';
    confetti.style.left=cx+'px';
    confetti.style.top=cy+'px';
    confetti.style.transition='transform 0.8s ease-out, opacity 0.8s';
    confetti.style.pointerEvents='none';
    document.body.appendChild(confetti);

    const angle = Math.random()*Math.PI*2;
    const dist = 150+Math.random()*50;
    const tx = Math.cos(angle)*dist;
    const ty = Math.sin(angle)*dist;

    setTimeout(()=>{
      confetti.style.transform=`translate(${tx}px, ${ty}px) rotate(${Math.random()*360}deg)`;
      confetti.style.opacity=0;
    },10);

    setTimeout(()=>{document.body.removeChild(confetti);},900);
  }
}

// ÂÆå‰∫Ü„É°„ÉÉ„Çª„Éº„Ç∏ÔºãÂ§ßÈáè„Ç®„Éï„Çß„ÇØ„ÉàÔºãSE
function showMessage(){
  const msg = document.getElementById('message');
  msg.textContent = 'üéâ Happy Birthday Grandpa! üéâ';
  pieces.forEach(p=>{
    p.style.transition='all 0.4s cubic-bezier(0.5,1.5,0.5,1.5)';
    p.style.transform='scale(1.1)';
    setTimeout(()=>{p.style.transform='scale(1)';},400);
  });

  for(let i=0;i<80;i++){
    const confetti = document.createElement('div');
    confetti.textContent='üéä';
    confetti.style.position='absolute';
    confetti.style.fontSize=Math.random()*30+10+'px';
    confetti.style.left=Math.random()*window.innerWidth+'px';
    confetti.style.top='-50px';
    confetti.style.transition='top 2s linear, opacity 2s';
    document.body.appendChild(confetti);
    setTimeout(()=>{confetti.style.top=window.innerHeight+'px'; confetti.style.opacity=0;},10);
    setTimeout(()=>{document.body.removeChild(confetti);},2100);
  }

  // „ÇØ„É™„Ç¢SE„Çí„Çø„ÉÉ„ÉÅÊìç‰Ωú„Å´Á¥ê‰ªò„Åë„Å¶ÂÜçÁîü
  document.body.addEventListener('click', playClearSEOnce, {once:true});
  document.body.addEventListener('touchstart', playClearSEOnce, {once:true});

  nextBtn.style.display='inline-block';
}

// „ÇØ„É™„ÉÉ„ÇØ/„Çø„ÉÉ„ÉÅÊôÇ„Å´È≥¥„Çâ„ÅôÈñ¢Êï∞
function playClearSEOnce(){
  seClearAudio.currentTime = 0;
  seClearAudio.play();
}

// Ê¨°„ÅÆ„Éë„Ç∫„É´
nextBtn.addEventListener('click', ()=>{
  const audio = new Audio(seClearUrl);
  audio.volume=0.3;
  audio.play();
  initPuzzle();
});

initPuzzle();
</script>

</body>
</html>

